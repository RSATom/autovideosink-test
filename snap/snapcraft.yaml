name: autovideosink-test
base: core24
version: git
summary: Test for GStreamer's `autovideosink` inside snap
description: Experimenting with ability to use `autovideosink` inside snap on arm devices (like Raspberry Pi) without X11 Server running.
license: GPL-3.0
grade: stable
confinement: strict

platforms:
  arm64:
#  amd64:

environment:
  GST_DEBUG: 3
  GST_DEBUG_NO_COLOR: 1
  GST_PLUGIN_PATH: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/gstreamer-1.0
  GST_PLUGIN_SYSTEM_PATH: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/gstreamer-1.0
  GST_PLUGIN_SCANNER: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner

layout:
  /etc/glvnd:
    bind: $SNAP/etc/glvnd
  /usr/share/glvnd:
    bind: $SNAP/usr/share/glvnd
  /usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/dri:
    bind: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/dri
  /usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/gbm:
    bind: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/gbm
  /usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/pulseaudio:
    bind: $SNAP/usr/lib/${CRAFT_ARCH_TRIPLET_BUILD_FOR}/pulseaudio

parts:
  test:
    plugin: cmake
    source: .
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/opt/${SNAPCRAFT_PROJECT_NAME}
    build-packages:
      - g++
      - make
      - libgstreamer1.0-dev
    stage-packages:
      - libpulse0
      - libegl-mesa0
      - libglu1-mesa
      - libgl1-mesa-dri
      - libglut3.12
      - va-driver-all
      - gstreamer1.0-plugins-base
      - gstreamer1.0-plugins-good
      - gstreamer1.0-gl

apps:
  test:
    command: opt/${SNAPCRAFT_PROJECT_NAME}/bin/autovideosink-test
    daemon: simple
    plugs:
      - opengl
